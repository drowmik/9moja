{% extends 'fb_scrapper/base.html' %}

{% block extra_css %}
    <style type="text/css">
        .btn {
            cursor: pointer
        }
    </style>
{% endblock %}

{% block extra_js %}
    <script type="text/javascript">
        var err_msg_elem = $('#error_msg')

        $('#chk_data').click(function (e) {
            e.preventDefault();
            if ($('#{{ form.page.name }}').val()) {
                $.ajax({
                    url: '{% url 'fbs:scrapper_data_ajax' %}',
                    method: 'GET',
                    data: {
                        "page": $('#{{ form.page.name }}').val(),
                        "fields": {
                            "0": "full_picture",
                            "1": "id"
                        },
                        "limit": "100"
                    },
                    dataType: 'json',
                    success: function (data) {
                        if (data["error"])
                            err_msg_elem.html(data["error"]["message"]);
                        else if (data["data"]) {
                            {% comment %}window.location.assign("{% url 'fbs:scrapper' %}"){% endcomment %}
                            d = data["data"];
                            console.log(d);
                            var img_count = 0;
                            var html = "";
                            for (var i = 0; i < d.length; i++) {
                                if (d[i]["full_picture"]) {
                                    if (img_count % 3 === 0) html += '<div class="row mb-3">';
                                    html +=
                                        '<div class="col-md-4">' +
                                        '<img src="' + d[i]["full_picture"] + '" class="w-100">' +
                                        '</div>';
                                    if (img_count % 3 === 2) html += '</div><!--'+img_count+'-->';
                                    img_count++;
                                }
                            }
                            $('#all_img').append(html);
                        } else {
                            err_msg_elem.html("Unexpected Fucking error occurred");
                        }
                    },
                    error: function (e) {
                        err_msg_elem.html("error!");
                        console.log(e);
                    }
                });
            } else {
                err_msg_elem.html("Please enter facebook page name");
            }
        })
    </script>
{% endblock %}


{% block main_container %}
    
    <div class="container">
        <div class="row">
            <div class="col">
                
                <p class="text-danger mb-0" id="error_msg"></p>
                
                {% if form.errors %}
                    <div class="text-danger">
                        {{ form.errors }}
                    </div>
                {% endif %}
                
                <form method="post">
                    
                    {% csrf_token %}
                    
                    <div class="form-group">
                        <label for="{{ form.page.name }}">Facebook page</label>
                        <input
                                type="text"
                                class="form-control"
                                id="{{ form.page.name }}"
                                name="{{ form.page.name }}"
                                placeholder="facebook Page url postfix">
                        <small class="form-text text-muted">Get it from url (https://facebook.com/this-is-page-name/)</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.name.name }}">Facebook page Name</label>
                        <input
                                type="text"
                                class="form-control"
                                id="{{ form.name.name }}"
                                name="{{ form.name.name }}"
                                placeholder="facebook Page name">
                    </div>
                    <button type="button" class="btn btn-success" id="chk_data">Check data</button>
                    <button type="submit" class="btn btn-primary">Submit</button>
                </form>
                
                <div id="fb_data">
                    <p class="message"></p>
                    <div id="all_img"></div>
                </div>
            </div>
        </div>
    </div>

{% endblock %}